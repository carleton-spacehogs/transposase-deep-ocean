---
title: "Graph metagenomic particle association and transposase abundance"
author: "Jimmy Zhong"
date: "8/19/2022"
output: html_document
---

```{r setup, include=FALSE}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path ))
source("./init_share.R")
g(DNA_tara, RNA_tara, DNA_RNA_tara) %=% init_tara()
mala_cov <- init_mala_cov()
mala_cov$size_fraction <- ifelse(mala_cov$lower_filter_size == "0.2", "planktonic", "particle")
DNA_tara$size_fraction <- ifelse(DNA_tara$upper_size_dna == "1.6", "planktonic", "particle")
```

## Will worry about scales later
```{r}
trans_RNA_scale <- c(-4.5, -4, -3.5, -3)
trans_RNA_percent_scale <- c("0.003", "0.010", "0.032", "0.100")
trans_scale <- c(-2.5, -3, -3.5, -4, -4.5)
trans_percent_scale <- c("0.316", "0.100", "0.032", "0.01", "0.003")
CAZ_percent_scale <- c(0.8, 0.4, 0.2, 0.1)
CAZ_scale <- log10(CAZ_percent_scale/100)

# BAT.sample.size = mala_cov[c('sample', 'lower_filter_size')]
# BAT.sample.size$filter_size = ifelse(
#   BAT.sample.size$lower_filter_size == 0.2, "0.2-0.8", "0.8-5.0")
# 
# BAT.sample.size = filter(BAT.sample.size, filter_size == "0.2-0.8")
# 
# BAT.COG.corr = COG.corr[COG.corr$Layer_DNA == "BAT", ]
# BAT.COG.corr = merge(BAT.COG.corr, BAT.sample.size, on = "sample")
# tara.COG.corr = COG.corr[COG.corr$Layer_DNA != "BAT", ]
```

## Data preparations
```{r}
DNA_RNA_tara_g = DNA_RNA_tara %>%
  filter(Layer_RNA != "MIX" & Ocean != "Arctic Ocean") %>%
  mutate(DNA_trans_percent = DNA_transposase * 100)

RNA_tara_g = RNA_tara %>%
  filter(Layer_RNA != "MIX" & Ocean != "Arctic Ocean") %>%
  mutate(RNA_trans_percent = RNA_transposase * 100) %>%
  mutate(Depth = factor(Layer_RNA, levels = c("BAT","MES","DCM","SRF")))

pt_sel_col <- c("log_dna_trans", "log_dna_defense","DNA_transposase",
                "log_dna_sect_CAZ","log_dna_sect_pep",
                "DNA_CAZyme","DNA_peptidase",
                "percent_dna_sect_CAZpep","percent_dna_sect_CAZ",
                "percent_dna_sect_pep",
                "Ocean_DNA", "Layer_DNA", "Oxygen_DNA", "size_fraction")
#  !mala_cov$sample %in% BAT.sample.size$sample

tmp = rbind(mala_cov[ ,pt_sel_col], DNA_tara[,pt_sel_col])
pt_to_graph = tmp %>%
  mutate(DNA_trans_percent = DNA_transposase * 100) %>%
  filter(Layer_DNA != "MIX" & Ocean_DNA != "Arctic") %>%
  mutate(Depth = factor(Layer_DNA, levels = c("SRF","DCM","MES","BAT")))
```

> summary(pt_to_graph$DNA_peptidase)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.004958 0.026718 0.029942 0.029231 0.034359 0.046223 
> summary(pt_to_graph$DNA_CAZyme)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.004601 0.015382 0.018450 0.018156 0.020963 0.029557
> sd(pt_to_graph$DNA_CAZyme)
[1] 0.004086007
> sd(pt_to_graph$DNA_peptidase)
[1] 0.00777566

The total abundance of CAZyme and peptidase are similar in magnitude

## RNA particle association to transposase abundance
```{r}
ann_text = data.frame(percent_rna_sect_CAZpep = 20, DNA_trans_percent = 0.05,
           label = "No metatranscriptome\nsamples available",
           Layer_RNA = factor("BAT",levels = c("SRF", "DCM", "MES", "BAT")))

DNA_RNA_tara_g %>%
  ggplot(aes(x=percent_rna_sect_CAZpep, y=DNA_trans_percent)) +
  # scale_y_continuous(breaks = trans_scale, labels = trans_percent_scale) +
  scale_color_brewer(palette="Set1")+
  facet_wrap(~Layer_RNA, ncol = 2) +
  geom_point(aes(color = Ocean)) + 
  scale_y_log10() +
  theme_classic() +
  labs( y = "Transposase gene abundance (%)",
        x = "Secretory CAZyme and peptidase transcript (%)") +
  geom_smooth(method = "lm", se = T) +
  geom_text(data = ann_text,label=ann_text$label)
  # theme(legend.position = "none")

## supplementary figure 1
ggsave("out/sectCAZpep_transpose_RNA.pdf",
       plot = last_plot(), width = 6.5, height = 5) 
```

## DNA particle assocation to transpoase abundance
```{r}
pt_to_graph %>%
  ggplot(aes(x=percent_dna_sect_CAZpep, y=DNA_trans_percent)) +
  scale_color_brewer(palette="Set1")+
  facet_wrap(~Depth) + # , scales = "free_y"
  geom_point(aes(color = Ocean_DNA)) + 
  theme_classic() +
  scale_y_log10() +
  labs( color = "Ocean", 
    y = "Transposase gene abundance (%)",
    x = "Secretory CAZyme and peptidase genes (%)") +
  geom_smooth(method = "lm", se = T)  +
  theme() # legend.position = "none"

## supplementary figure 2
ggsave("out/sectCAZpep_transpose_DNA.pdf",
       plot = last_plot(), width = 6.5, height = 5)
```


## indiviudal CAZyme and peptidase

Correlation with transposase abundance (DNA and RNA)
```{r}
gen_corr_shared = function(g, gene, type) {
  g = g + theme_classic() + 
    scale_y_continuous(trans = "log10",
                       limits = c(min(RNA_tara_g$RNA_trans_percent)*0.99,
                                  1.2),
                       labels = function(x) ifelse(x == 0, "0", x)) +
    scale_color_brewer(palette="Set1") +
    # geom_smooth(method = "lm", se = T) +
    stat_cor(method = "spearman", cor.coef.name = "rho") +
    # stat_poly_eq(formula = y ~ x, aes(label = paste(..eq.label.., 
    #                 ..rr.label.., sep = "~~~")), parse=TRUE) + 
    labs( color = "Depth",
          x = sprintf("Secretory %s %ss (%%)", gene, type),
          y = sprintf("Transposase\n%s abundance (%%)", type))
    
  return(g)
}

gen_RNA_corr = function(x_var, gene, type){
  g = RNA_tara_g %>%
  ggplot(aes_string(x=x_var, y="RNA_trans_percent")) +
    geom_point(aes(color = Layer_RNA)) + 
    scale_x_log10()
  g = gen_corr_shared(g, gene, type)
  return(g)
}

gen_DNA_corr = function(x_var, gene, type){
  g = pt_to_graph %>%
    ggplot(aes_string(x=x_var, y="DNA_trans_percent")) +
    geom_point(aes(color = Depth))
  g = gen_corr_shared(g, gene, type)
  return(g)
}

CAZ_RNA = gen_RNA_corr("percent_rna_sect_CAZ", "CAZyme", "transcript") +
  theme(legend.position = "none")

pep_RNA = gen_RNA_corr("percent_rna_sect_pep", "peptidase", "transcript") +
  theme( axis.title.y = element_blank() )

CAZ_DNA = gen_DNA_corr("percent_dna_sect_CAZ", "CAZyme", "gene") +
  theme(legend.position = "none")

pep_DNA = gen_DNA_corr("percent_dna_sect_pep", "peptidase", "gene") +
  theme( axis.title.y = element_blank() )

ggarrange(CAZ_DNA, pep_DNA, CAZ_RNA, pep_RNA,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2, widths = c(0.45, 0.55))

ggsave(paste0(googleDrive.loc, "/Figure2_CAZyme_peptidase_separate_corr.pdf"),
       plot = last_plot(), width = 7, height = 5.6)

ggsave("out/CAZyme_peptidase_separate_corr.pdf",
       width = 7, height = 5.6)
```

## Show that deep oceans rely more on particle-associated lifestyle (RNA)
```{r}
RNA_tara_g %>%
  ggplot(aes(x = percent_rna_sect_pep, y= log_rna_trans)) +
  geom_point(aes(color = Layer_RNA)) +
  scale_x_log10() +
  facet_wrap(~Ocean) +
  geom_smooth(method = "lm", se = F)

summary(lm(log_dna_trans~Depth + Ocean + Oxygen_DNA, pt_to_graph))
summary(lm(log_dna_trans~Depth + Ocean + Oxygen_DNA, DNA_RNA_tara))

gen_depth_shared = function(data, data.test) {
  g = ggplot(data, aes(x=Depth, y=cur_var)) + 
    geom_boxplot(outlier.colour = NA) +
    geom_jitter(aes(color=Ocean), alpha = 0.7,
                width = 0.2, height = 0, size = 1) +
    stat_pvalue_manual(data.test, label = "p.adj.signif", 
                       tip.length = 0.01, hide.ns = TRUE)+ 
    scale_color_brewer(palette="Set1") +
    theme_classic() + 
    theme(axis.title.y = element_blank()) +
    coord_flip()
  return(g)
}

gen_RNA_depth = function(x_var, position_vec, text_pos){
  RNA_tara_g['cur_var'] = RNA_tara_g[x_var]
  secretory_rna.test <- RNA_tara_g %>%
  rstatix::wilcox_test(cur_var ~ Layer_RNA) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>%
  add_xy_position() %>%
  mutate(xmin = xmin + 1, xmax = xmax + 1) # for the empty BAT group
  
  secretory_rna.test$y.position = position_vec
  
  ann_text2 = data.frame(cur_var = text_pos,
    label = "Metatranscriptome samples unavailable",
    Depth = factor("BAT",levels = c("BAT","MES","DCM","SRF")))
  
  set.seed(33)

  RNA_particle = gen_depth_shared(RNA_tara_g, secretory_rna.test) +
    scale_x_discrete(drop=FALSE) +
    geom_text(data = ann_text2,label=ann_text2$label)
  return(RNA_particle)
}

# Maybe I don't need this?
# gen_RNA_depth("percent_rna_sect_CAZpep", c(31, 33.3, 29.7), 21) +
#   ylab("secretory CAZyme and peptidase transcript (%)")

CAZ_RNA_depth = gen_RNA_depth("percent_rna_sect_CAZ",
  c(14.5, 16, 13), 11) +
  ylab("secretory CAZyme transcript (%)") +
  theme(legend.position = "none")

pep_RNA_depth = gen_RNA_depth("percent_rna_sect_pep", c(51, 53, 47), 32) +
  ylab("secretory peptidase transcript (%)") +
  theme(legend.position = "none")
```

## Show that deep oceans rely more on particle-associated lifestyle (DNA)
```{r}
gen_DNA_depth = function(x_var, position_vec, seed = 33){
  pt_to_graph['cur_var'] = pt_to_graph[x_var]
  secretory_dna.test = pt_to_graph %>%
  mutate(Depth = fct_rev(Depth)) %>% 
  rstatix::wilcox_test(cur_var ~ Depth) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>%
  add_xy_position()

  secretory_dna.test$y.position = position_vec

  set.seed(seed)
  DNA_particle = pt_to_graph %>%
    mutate(Depth = fct_rev(Depth),
           Ocean = Ocean_DNA) %>% 
    gen_depth_shared(secretory_dna.test)
  return(DNA_particle)
}

CAZ_DNA_depth = gen_DNA_depth("percent_dna_sect_CAZ",
  c(21, 22, 23, 19, 20, 10.0), seed = 44) +
  ylab("secretory CAZyme genes (%)") +
  theme(legend.position = "none")

pep_DNA_depth = gen_DNA_depth("percent_dna_sect_pep",
                  c(38, 39, 40, 35, 36, 10)) +
                  ylab("secretory peptidase genes (%)")

blank_plot = ggplot() + theme_void()

ggarrange( nrow = 2,
  ggarrange( CAZ_DNA_depth, pep_DNA_depth, ncol = 2,
        labels = c("A","B"), widths = c(0.4, 0.55)),
  ggarrange( CAZ_RNA_depth, pep_RNA_depth, blank_plot, ncol = 3,
        labels = c("C","D"), widths = c(0.4, 0.4, 0.15)))

## supplementary figure 3
ggsave("out/sectCAZpep_increase_depth.pdf",
       plot = last_plot(), width = 9, height = 5.5)
```

## stats section for particle-assocation transposase correlation

The anova for RNA is insignificant: 0.8823
But it is stronger for the DNA: 9.231e-11

> get_r(DNA.corr.particle) - get_r(DNA.corr.depth)
[1] 0.06233815
> get_r(DNA.corr.particle)
[1] 0.7128721
> get_r(DNA.corr.depth)
[1] 0.6505339

```{r}
reg.stats = function(big_df, depth, feature, trans) {
  tmp_df = big_df[c(feature, depth, "Ocean", trans)]
  colnames(tmp_df) = c("feature", "depth", "ocean", "trans")
  corr.depth = lm(trans~depth, tmp_df)
  corr.particle = lm(trans~depth + feature, tmp_df)
  print(summary(corr.particle))
  ano_obj = anova(corr.depth, corr.particle)
  
  n_row = data.frame(feature = feature,
     sample.n = nrow(tmp_df),
     depth.norm = shapiro.test(resid(corr.depth))$p.val,
     feature.norm = shapiro.test(resid(corr.particle))$p.val,
     depth.R = get_r(corr.depth), 
     feature.R = get_r(corr.particle),
     p.val = ano_obj$`Pr(>F)`[2])
  return(n_row)
}

cols = c("log_dna_trans","Depth","Ocean_DNA", "Layer_DNA")
tmp = rbind(DNA_tara[cols], mala_cov[cols])
tmp = tmp[tmp$Ocean_DNA != "Arctic", ]

summary(lm(log_dna_trans~Layer_DNA, tmp ))
summary(lm(log_dna_trans~Depth, pt_to_graph))

# DNA_RNA_tara_g$Depth = DNA_RNA_tara_g$Layer_RNA
# DNA_RNA_tara_g$log_percent_CAZ = log(DNA_RNA_tara_g$percent_rna_sect_CAZ)
pt_to_graph$Ocean = pt_to_graph$Ocean_DNA
RNA_tara_g$log_percent_CAZ = log(RNA_tara_g$percent_rna_sect_CAZ)
RNA_tara_g$log_percent_pep = log(RNA_tara_g$percent_rna_sect_pep)
reg1 = reg.stats(pt_to_graph[!is.na(pt_to_graph$Oxygen_DNA), ],
                 "Layer_DNA", "Oxygen_DNA", "log_dna_trans")
reg2 = reg.stats(pt_to_graph, "Layer_DNA", "percent_dna_sect_CAZ", "log_dna_trans")
reg3 = reg.stats(pt_to_graph, "Layer_DNA", "percent_dna_sect_pep", "log_dna_trans")
reg4 = reg.stats(RNA_tara_g, "Layer_RNA", "log_percent_CAZ", "log_rna_trans")
reg5 = reg.stats(RNA_tara_g, "Layer_RNA", "log_percent_pep", "log_rna_trans")

CAZpep.reg = rbind(reg1, reg2, reg3, reg4, reg5) %>%
  adjust_pvalue(method = "BY")

write.csv(CAZpep.reg, file = "redux_out/regression-results.csv")
# DNA.corr.depth = lm(log_dna_trans~Depth, pt_to_graph )
# DNA.corr.particle = lm(log_dna_trans~Depth + log(percent_dna_sect_CAZpep), pt_to_graph )
# anova(DNA.corr.depth, DNA.corr.particle)
```


## Arctic Ocean have higher secretory CAZyme peptidase percentage

Have to do log transformation to make sure that both groups have
normal distributions.

RNA p-val = 1.037e-09
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.3011970 -0.1680382
sample estimates:
mean of x mean of y 
 2.862235  3.096852 
 
** the difference is around 26.4% in RNA **
> exp(3.096852-2.862235)
[1] 1.264424

** 95% CI ** 
> exp(0.3011970)
[1] 1.351476
> exp(0.1680382)
[1] 1.182982


```{r}
RNA.arctic = RNA_tara_g[c("percent_rna_sect_CAZpep", "Ocean")] %>%
  mutate(is_arctic = ifelse(Ocean == "Arctic Ocean", "Arctic", "Non-arctic"))

RNA.arctic = log(RNA_tara_g[RNA_tara_g$Ocean == "Arctic Ocean",
                        "percent_rna_sect_CAZpep"])
RNA.non.arctic = log(RNA_tara_g[RNA_tara_g$Ocean != "Arctic Ocean",
                        "percent_rna_sect_CAZpep"])

# normality assumption met
shapiro.test(RNA.non.arctic)
shapiro.test(RNA.arctic)
# equal variance not met
var.test(RNA.non.arctic, RNA.arctic)
# do t test
t.test(RNA.non.arctic, RNA.arctic, var.equal = FALSE)
```

## Now do the same thing for DNA

Can't get the normality assumption to work...
Go with non parametric

```{r}
DNA.arctic = pt_to_graph[pt_to_graph$Ocean_DNA == "Arctic",]$percent_dna_sect_CAZpep
DNA.non.arctic = pt_to_graph[pt_to_graph$Ocean_DNA != "Arctic",]$percent_dna_sect_CAZpep

# normality assumption met
shapiro.test(DNA.arctic)
shapiro.test(DNA.non.arctic)

wilcox.test(DNA.arctic, DNA.non.arctic)
wilcox.test(RNA.arctic, RNA.non.arctic)
```


